name: Java Migration Automation

on:
  workflow_dispatch:
    inputs:
      migration_type:
        description: 'Migration Strategy'
        required: true
        type: choice
        options:
          - 'single-step'
          - 'sequential-all'
        default: 'single-step'
      target_java_version:
        description: 'Target Java Version (for single-step migration)'
        required: false
        type: choice
        options:
          - '11'
          - '17'
          - '21'
          - '25'
        default: '11'

env:
  MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.class=standard -Dmaven.wagon.http.retryHandler.count=3

jobs:
  single-step-migration:
    name: Migrate to Java ${{ github.event.inputs.target_java_version }}
    runs-on: ubuntu-latest
    if: github.event.inputs.migration_type == 'single-step'
    
    steps:
      - name: Checkout spring-petclinic
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 17 for OpenRewrite
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create migration branch
        run: |
          BRANCH_NAME="migration/java-${{ github.event.inputs.target_java_version }}-$(date +%Y%m%d-%H%M%S)"
          echo "MIGRATION_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b $BRANCH_NAME

      - name: Run Migration to Java ${{ github.event.inputs.target_java_version }}
        run: |
          TARGET_VERSION=${{ github.event.inputs.target_java_version }}
          echo "üöÄ Starting migration to Java $TARGET_VERSION"
          
          case $TARGET_VERSION in
            11)
              echo "Migrating Java 8 ‚Üí 11"
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.Java8toJava11 \
                -Drewrite.exportDatatables=true
              
              # Update Spring Boot to compatible version (2.7.x for Java 11)
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:5.20.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_7
              ;;
              
            17)
              echo "Migrating to Java 17 (via Java 11)"
              # First migrate to Java 11
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.Java8toJava11
              
              # Then migrate to Java 17
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava17
              
              # Update Spring Boot to 3.x (requires Java 17)
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:5.20.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_2
              ;;
              
            21)
              echo "Migrating to Java 21 (full path: 8‚Üí11‚Üí17‚Üí21)"
              # Java 8 ‚Üí 11
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.Java8toJava11
              
              # Java 11 ‚Üí 17
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava17
              
              # Java 17 ‚Üí 21
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava21
              
              # Update Spring Boot to latest 3.x
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:5.20.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_3
              ;;
              
            25)
              echo "Migrating to Java 25 (full path: 8‚Üí11‚Üí17‚Üí21‚Üí25)"
              echo "‚ö†Ô∏è  Note: Java 25 is experimental. Applying migrations up to Java 21."
              
              # Java 8 ‚Üí 11
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.Java8toJava11
              
              # Java 11 ‚Üí 17
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava17
              
              # Java 17 ‚Üí 21
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava21
              
              # Update Spring Boot
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:5.20.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_3
              
              # Manually update to Java 25 in pom.xml
              sed -i 's/<java.version>.*<\/java.version>/<java.version>25<\/java.version>/g' pom.xml
              sed -i 's/<maven.compiler.source>.*<\/maven.compiler.source>/<maven.compiler.source>25<\/maven.compiler.source>/g' pom.xml
              sed -i 's/<maven.compiler.target>.*<\/maven.compiler.target>/<maven.compiler.target>25<\/maven.compiler.target>/g' pom.xml
              ;;
          esac

      - name: Update Maven Wrapper (if needed)
        run: |
          if [ -f "mvnw" ]; then
            ./mvnw wrapper:wrapper -Dmaven=3.9.6
          fi

      - name: Set up Target JDK for Build
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ github.event.inputs.target_java_version }}
          cache: 'maven'

      - name: Build with Maven
        run: |
          echo "üî® Building project with Java ${{ github.event.inputs.target_java_version }}"
          mvn clean verify -DskipTests
        continue-on-error: true

      - name: Run Tests
        run: |
          echo "üß™ Running tests"
          mvn test
        continue-on-error: true

      - name: Generate Migration Report
        run: |
          cat > MIGRATION_REPORT.md << EOF
          # Java Migration Report
          
          ## Migration Details
          - **From:** Java 8
          - **To:** Java ${{ github.event.inputs.target_java_version }}
          - **Date:** $(date)
          - **Branch:** ${{ env.MIGRATION_BRANCH }}
          
          ## Changes Applied
          - ‚úÖ Java version upgraded
          - ‚úÖ Spring Boot dependencies updated
          - ‚úÖ Code refactored using OpenRewrite
          - ‚úÖ Build verification attempted
          
          ## Next Steps
          1. Review the automated changes
          2. Run full test suite locally
          3. Check for any manual migration tasks
          4. Update documentation
          5. Test the application thoroughly
          
          ## OpenRewrite Recipes Applied
          EOF
          
          case ${{ github.event.inputs.target_java_version }} in
            11)
              echo "- org.openrewrite.java.migrate.Java8toJava11" >> MIGRATION_REPORT.md
              echo "- org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_7" >> MIGRATION_REPORT.md
              ;;
            17)
              echo "- org.openrewrite.java.migrate.Java8toJava11" >> MIGRATION_REPORT.md
              echo "- org.openrewrite.java.migrate.UpgradeToJava17" >> MIGRATION_REPORT.md
              echo "- org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_2" >> MIGRATION_REPORT.md
              ;;
            21|25)
              echo "- org.openrewrite.java.migrate.Java8toJava11" >> MIGRATION_REPORT.md
              echo "- org.openrewrite.java.migrate.UpgradeToJava17" >> MIGRATION_REPORT.md
              echo "- org.openrewrite.java.migrate.UpgradeToJava21" >> MIGRATION_REPORT.md
              echo "- org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_3" >> MIGRATION_REPORT.md
              ;;
          esac
          
          cat MIGRATION_REPORT.md

      - name: Commit Changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            git commit -m "üöÄ Migrate to Java ${{ github.event.inputs.target_java_version }} with updated dependencies

          - Upgraded from Java 8 to Java ${{ github.event.inputs.target_java_version }}
          - Updated Spring Boot and dependencies
          - Applied OpenRewrite migration recipes
          - Generated migration report
          
          Co-authored-by: OpenRewrite <info@moderne.io>"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi

      - name: Push Changes
        if: env.HAS_CHANGES == 'true'
        run: |
          git push origin ${{ env.MIGRATION_BRANCH }}

      - name: Create Pull Request
        if: env.HAS_CHANGES == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.MIGRATION_BRANCH }}
          title: "üöÄ Migrate Spring PetClinic to Java ${{ github.event.inputs.target_java_version }}"
          body: |
            ## üéØ Automated Java Migration
            
            This PR migrates the Spring PetClinic application from Java 8 to Java **${{ github.event.inputs.target_java_version }}**.
            
            ### üìã Migration Summary
            
            | Item | Status |
            |------|--------|
            | Java Version | 8 ‚Üí ${{ github.event.inputs.target_java_version }} |
            | Spring Boot | Updated ‚úÖ |
            | Dependencies | Updated ‚úÖ |
            | Code Refactoring | Completed ‚úÖ |
            | Build Status | Check workflow results |
            
            ### üîß Changes Applied
            
            - Upgraded Java version in `pom.xml`
            - Updated Spring Boot to compatible version
            - Migrated deprecated APIs
            - Updated dependencies for Java ${{ github.event.inputs.target_java_version }} compatibility
            - Applied OpenRewrite migration recipes
            
            ### ‚úÖ Review Checklist
            
            - [ ] Review code changes in detail
            - [ ] Run `mvn clean install` locally
            - [ ] Run full test suite: `mvn test`
            - [ ] Test application startup
            - [ ] Verify all features work correctly
            - [ ] Check for deprecation warnings
            - [ ] Update README if needed
            - [ ] Review migration report (see MIGRATION_REPORT.md)
            
            ### üìö Documentation
            
            See `MIGRATION_REPORT.md` for detailed migration information.
            
            ### ü§ñ Automated by
            
            This migration was performed automatically using OpenRewrite and GitHub Actions.
            
            ---
            
            **Note:** Please review all changes carefully before merging. Some manual adjustments may be required.
          labels: |
            migration
            automated
            java-${{ github.event.inputs.target_java_version }}
            enhancement
          draft: false

  sequential-migration:
    name: Sequential Migration - ${{ matrix.step_name }}
    runs-on: ubuntu-latest
    if: github.event.inputs.migration_type == 'sequential-all'
    
    strategy:
      matrix:
        include:
          - step_name: "Java 8 to 11"
            java_version: "11"
            base_branch: "main"
            recipe: "org.openrewrite.java.migrate.Java8toJava11"
            spring_recipe: "org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_7"
          - step_name: "Java 11 to 17"
            java_version: "17"
            base_branch: "migration/java-11"
            recipe: "org.openrewrite.java.migrate.UpgradeToJava17"
            spring_recipe: "org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_2"
          - step_name: "Java 17 to 21"
            java_version: "21"
            base_branch: "migration/java-17"
            recipe: "org.openrewrite.java.migrate.UpgradeToJava21"
            spring_recipe: "org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_3"
      max-parallel: 1
    
    steps:
      - name: Checkout spring-petclinic
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ matrix.base_branch }}

      - name: Set up JDK 17 for OpenRewrite
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create migration branch
        run: |
          BRANCH_NAME="migration/java-${{ matrix.java_version }}"
          echo "MIGRATION_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b $BRANCH_NAME 2>/dev/null || git checkout $BRANCH_NAME

      - name: Run Java Migration
        run: |
          echo "Running migration: ${{ matrix.step_name }}"
          mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
            -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
            -Drewrite.activeRecipes=${{ matrix.recipe }}

      - name: Run Spring Boot Migration
        run: |
          echo "Updating Spring Boot"
          mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
            -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:5.20.0 \
            -Drewrite.activeRecipes=${{ matrix.spring_recipe }}

      - name: Set up Target JDK for Build
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java_version }}
          cache: 'maven'

      - name: Build and Test
        run: |
          mvn clean install
          mvn test
        continue-on-error: true

      - name: Commit and Push
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sequential migration: ${{ matrix.step_name }}"
            git push origin ${{ env.MIGRATION_BRANCH }} --force
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.MIGRATION_BRANCH }}
          title: "Sequential Migration: ${{ matrix.step_name }}"
          body: |
            ## Sequential Migration Step
            
            **Migration:** ${{ matrix.step_name }}
            
            This is part of the sequential migration from Java 8 to Java 21.
            
            ### Changes:
            - Applied: `${{ matrix.recipe }}`
            - Applied: `${{ matrix.spring_recipe }}`
            
            ### Next Steps:
            - Review and merge this PR
            - The next migration step will build on this branch
          labels: |
            migration
            automated
            sequential
            java-${{ matrix.java_version }}
