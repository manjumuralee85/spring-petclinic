name: Java Migration Automation

on:
  workflow_dispatch:
    inputs:
      migration_type:
        description: 'Migration Strategy'
        required: true
        type: choice
        options:
          - 'single-step'
          - 'sequential-all'
        default: 'single-step'
      target_java_version:
        description: 'Target Java Version (for single-step migration)'
        required: false
        type: choice
        options:
          - '11'
          - '17'
          - '21'
          - '25'
        default: '11'

env:
  MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.class=standard -Dmaven.wagon.http.retryHandler.count=3

jobs:
  single-step-migration:
    name: Migrate to Java ${{ github.event.inputs.target_java_version }}
    runs-on: ubuntu-latest
    if: github.event.inputs.migration_type == 'single-step'
    
    steps:
      - name: Checkout spring-petclinic
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 17 for OpenRewrite
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create migration branch
        run: |
          BRANCH_NAME="migration/java-${{ github.event.inputs.target_java_version }}-$(date +%Y%m%d-%H%M%S)"
          echo "MIGRATION_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b $BRANCH_NAME

      - name: Add OpenRewrite Plugin to pom.xml
        run: |
          # Backup original pom.xml
          cp pom.xml pom.xml.backup
          
          # Check if OpenRewrite plugin already exists
          if ! grep -q "rewrite-maven-plugin" pom.xml; then
            echo "Adding OpenRewrite plugin to pom.xml"
            # This adds the plugin to the build section
            cat > add-plugin.xml << 'EOF'
          <plugin>
            <groupId>org.openrewrite.maven</groupId>
            <artifactId>rewrite-maven-plugin</artifactId>
            <version>5.40.0</version>
            <configuration>
              <activeRecipes>
                <recipe>org.openrewrite.java.migrate.JavaMigration</recipe>
              </activeRecipes>
            </configuration>
            <dependencies>
              <dependency>
                <groupId>org.openrewrite.recipe</groupId>
                <artifactId>rewrite-migrate-java</artifactId>
                <version>2.25.0</version>
              </dependency>
              <dependency>
                <groupId>org.openrewrite.recipe</groupId>
                <artifactId>rewrite-spring</artifactId>
                <version>5.20.0</version>
              </dependency>
            </dependencies>
          </plugin>
          EOF
          fi

      - name: Run Migration to Java ${{ github.event.inputs.target_java_version }}
        run: |
          TARGET_VERSION=${{ github.event.inputs.target_java_version }}
          echo "üöÄ Starting migration to Java $TARGET_VERSION"
          
          case $TARGET_VERSION in
            11)
              echo "Migrating Java 8 ‚Üí 11"
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.Java8toJava11 \
                -Drewrite.exportDatatables=true
              
              # Update Spring Boot to compatible version (2.7.x for Java 11)
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:5.20.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_7
              ;;
              
            17)
              echo "Migrating to Java 17 (via Java 11)"
              # First migrate to Java 11
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.Java8toJava11
              
              # Then migrate to Java 17
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava17
              
              # Update Spring Boot to 3.x (requires Java 17)
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:5.20.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_2
              ;;
              
            21)
              echo "Migrating to Java 21 (full path: 8‚Üí11‚Üí17‚Üí21)"
              # Java 8 ‚Üí 11
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.Java8toJava11
              
              # Java 11 ‚Üí 17
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava17
              
              # Java 17 ‚Üí 21
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava21
              
              # Update Spring Boot to latest 3.x
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:5.20.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_3
              ;;
              
            25)
              echo "Migrating to Java 25 (full path: 8‚Üí11‚Üí17‚Üí21‚Üí25)"
              echo "‚ö†Ô∏è  Note: Java 25 is experimental. Applying migrations up to Java 21."
              
              # Java 8 ‚Üí 11
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.Java8toJava11
              
              # Java 11 ‚Üí 17
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava17
              
              # Java 17 ‚Üí 21
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava21
              
              # Update Spring Boot
              mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
                -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:5.20.0 \
                -Drewrite.activeRecipes=org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_3
              
              # Manually update to Java 25 in pom.xml
              sed -i 's/<java.version>.*<\/java.version>/<java.version>25<\/java.version>/g' pom.xml
              sed -i 's/<maven.compiler.source>.*<\/maven.compiler.source>/<maven.compiler.source>25<\/maven.compiler.source>/g' pom.xml
              sed -i 's/<maven.compiler.target>.*<\/maven.compiler.target>/<maven.compiler.target>25<\/maven.compiler.target>/g' pom.xml
              ;;
          esac

      - name: Update Maven Wrapper (if needed)
        run: |
          if [ -f "mvnw" ]; then
            ./mvnw wrapper:wrapper -Dmaven=3.9.6
          fi

      - name: Set up Target JDK for Build
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ github.event.inputs.target_java_version }}
          cache: 'maven'

      - name: Build with Maven
        run: |
          echo "üî® Building project with Java ${{ github.event.inputs.target_java_version }}"
          mvn clean verify -DskipTests
        continue-on-error: true

      - name: Run Tests
        run: |
          echo "üß™ Running tests"
          mvn test
        continue-on-error: true

      - name: Generate Migration Report
        run: |
          cat > MIGRATION_REPORT.md << EOF
          # Java Migration Report
          
          ## Migration Details
          - **From:** Java 8
          - **To:** Java ${{ github.event.inputs.target_java_version }}
          - **Date:** $(date)
          - **Branch:** ${{ env.MIGRATION_BRANCH }}
          
          ## Changes Applied
          - ‚úÖ Java version upgraded
          - ‚úÖ Spring Boot dependencies updated
          - ‚úÖ Code refactored using OpenRewrite
          - ‚úÖ Build verification attempted
          
          ## Next Steps
          1. Review the automated changes
          2. Run full test suite locally
          3. Check for any manual migration tasks
          4. Update documentation
          5. Test the application thoroughly
          
          ## OpenRewrite Recipes Applied
          EOF
          
          case ${{ github.event.inputs.target_java_version }} in
            11)
              echo "- org.openrewrite.java.migrate.Java8toJava11" >> MIGRATION_REPORT.md
              echo "- org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_7" >> MIGRATION_REPORT.md
              ;;
            17)
              echo "- org.openrewrite.java.migrate.Java8toJava11" >> MIGRATION_REPORT.md
              echo "- org.openrewrite.java.migrate.UpgradeToJava17" >> MIGRATION_REPORT.md
              echo "- org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_2" >> MIGRATION_REPORT.md
              ;;
            21|25)
              echo "- org.openrewrite.java.migrate.Java8toJava11" >> MIGRATION_REPORT.md
              echo "- org.openrewrite.java.migrate.UpgradeToJava17" >> MIGRATION_REPORT.md
              echo "- org.openrewrite.java.migrate.UpgradeToJava21" >> MIGRATION_REPORT.md
              echo "- org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_3" >> MIGRATION_REPORT.md
              ;;
          esac
          
          cat MIGRATION_REPORT.md

      - name: Commit Changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üöÄ Migrate to Java ${{ github.event.inputs.target_java_version }} with updated dependencies

          - Upgraded from Java 8 to Java ${{ github.event.inputs.target_java_version }}
          - Updated Spring Boot and dependencies
          - Applied OpenRewrite migration recipes
          - Generated migration report
          
          Co-authored-by: OpenRewrite <info@moderne.io>"
          fi

      - name: Push Changes
        run: |
          git push origin ${{ env.MIGRATION_BRANCH }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.MIGRATION_BRANCH }}
          title: "üöÄ Migrate Spring PetClinic to Java ${{ github.event.inputs.target_java_version }}"
          body: |
            ## üéØ Automated Java Migration
            
            This PR migrates the Spring PetClinic application from Java 8 to Java **${{ github.event.inputs.target_java_version }}**.
            
            ### üìã Migration Summary
            
            | Item | Status |
            |------|--------|
            | Java Version | 8 ‚Üí ${{ github.event.inputs.target_java_version }} |
            | Spring Boot | Updated ‚úÖ |
            | Dependencies | Updated ‚úÖ |
            | Code Refactoring | Completed ‚úÖ |
            | Build Status | Check workflow results |
            
            ### üîß Changes Applied
            
            - Upgraded Java version in `pom.xml`
            - Updated Spring Boot to compatible version
            - Migrated deprecated APIs
            - Updated dependencies for Java ${{ github.event.inputs.target_java_version }} compatibility
            - Applied OpenRewrite migration recipes
            
            ### ‚úÖ Review Checklist
            
            - [ ] Review code changes in detail
            - [ ] Run `mvn clean install` locally
            - [ ] Run full test suite: `mvn test`
            - [ ] Test application startup
            - [ ] Verify all features work correctly
            - [ ] Check for deprecation warnings
            - [ ] Update README if needed
            - [ ] Review migration report (see MIGRATION_REPORT.md)
            
            ### üìö Documentation
            
            See `MIGRATION_REPORT.md` for detailed migration information.
            
            ### ü§ñ Automated by
            
            This migration was performed automatically using OpenRewrite and GitHub Actions.
            
            ---
            
            **Note:** Please review all changes carefully before merging. Some manual adjustments may be required.
          labels: |
            migration
            automated
            java-${{ github.event.inputs.target_java_version }}
            enhancement
          draft: false

  sequential-migration:
    name: Sequential Migration (Java 8 ‚Üí 11 ‚Üí 17 ‚Üí 21 ‚Üí 25)
    runs-on: ubuntu-latest
    if: github.event.inputs.migration_type == 'sequential-all'
    
    strategy:
      matrix:
        java_version: [11, 17, 21]
      max-parallel: 1
    
    steps:
      - name: Checkout spring-petclinic
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ matrix.java_version == 11 && 'main' || format('migration/java-{0}', matrix.java_version - (matrix.java_version == 17 && 6 || 4)) }}

      - name: Set up JDK 17 for OpenRewrite
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create migration branch
        run: |
          BRANCH_NAME="migration/java-${{ matrix.java_version }}"
          echo "MIGRATION_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b $BRANCH_NAME || git checkout $BRANCH_NAME

      - name: Run Migration to Java ${{ matrix.java_version }}
        run: |
          TARGET=${{ matrix.java_version }}
          
          if [ $TARGET -eq 11 ]; then
            mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
              -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
              -Drewrite.activeRecipes=org.openrewrite.java.migrate.Java8toJava11
            
            mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
              -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:5.20.0 \
              -Drewrite.activeRecipes=org.openrewrite.java.spring.boot2.UpgradeSpringBoot_2_7
          
          elif [ $TARGET -eq 17 ]; then
            mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
              -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
              -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava17
            
            mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
              -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:5.20.0 \
              -Drewrite.activeRecipes=org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_2
          
          elif [ $TARGET -eq 21 ]; then
            mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
              -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:2.25.0 \
              -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava21
            
            mvn -U org.openrewrite.maven:rewrite-maven-plugin:5.40.0:run \
              -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:5.20.0 \
              -Drewrite.activeRecipes=org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_3
          fi

      - name: Commit and Push
        run: |
          git add -A
          git commit -m "Migrate to Java ${{ matrix.java_version }}" || echo "No changes"
          git push origin ${{ env.MIGRATION_BRANCH }} --force

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.MIGRATION_BRANCH }}
          title: "Sequential Migration: Java ${{ matrix.java_version }}"
          body: |
            Sequential migration step to Java ${{ matrix.java_version }}
          labels: migration,automated,java-${{ matrix.java_version }}
