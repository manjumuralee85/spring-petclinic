name: Java Migration Automation

on:
  workflow_dispatch:
    inputs:
      target_java_version:
        description: 'Target Java Version'
        required: true
        type: choice
        options:
          - '21'
          - '25'
        default: '21'

env:
  MAVEN_OPTS: -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.class=standard -Dmaven.wagon.http.retryHandler.count=3

jobs:
  detect-current-version:
    name: Detect Current Java Version
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.detect.outputs.current_version }}
      can_migrate: ${{ steps.detect.outputs.can_migrate }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect current Java version
        id: detect
        run: |
          if [ -f "pom.xml" ]; then
            JAVA_VERSION=$(grep -oP '<java.version>\K[^<]+' pom.xml || echo "17")
            echo "current_version=$JAVA_VERSION" >> $GITHUB_OUTPUT
            echo "Current Java version detected: $JAVA_VERSION"
            
            TARGET=${{ github.event.inputs.target_java_version }}
            if [ "$JAVA_VERSION" -lt "$TARGET" ]; then
              echo "can_migrate=true" >> $GITHUB_OUTPUT
              echo "âœ“ Can migrate from Java $JAVA_VERSION to Java $TARGET"
            else
              echo "can_migrate=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ Cannot migrate: Current version ($JAVA_VERSION) >= Target version ($TARGET)"
            fi
          else
            echo "current_version=17" >> $GITHUB_OUTPUT
            echo "can_migrate=true" >> $GITHUB_OUTPUT
          fi

  migrate-java:
    name: Migrate to Java ${{ github.event.inputs.target_java_version }}
    runs-on: ubuntu-latest
    needs: detect-current-version
    if: needs.detect-current-version.outputs.can_migrate == 'true'
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout spring-petclinic
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17 for OpenRewrite
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Clear cached OpenRewrite artifacts
        run: |
          rm -rf ~/.m2/repository/org/openrewrite || true

      - name: Set branch name
        run: |
          BRANCH_NAME="migration/java-${{ github.event.inputs.target_java_version }}-$(date +%Y%m%d-%H%M%S)"
          echo "MIGRATION_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV
          echo "Branch name: $BRANCH_NAME"

      - name: Ensure .gitignore excludes build artifacts
        run: |
          # Create/update .gitignore to exclude build artifacts
          cat >> .gitignore << 'EOF'
          
          # Build artifacts (should not be in PR)
          target/
          *.class
          *.jar
          *.war
          *.ear
          
          # OpenRewrite
          .rewrite/
          rewrite.patch
          
          # IDE files
          .idea/
          *.iml
          .classpath
          .project
          .settings/
          EOF
          
          # Remove duplicates
          sort -u .gitignore -o .gitignore
          echo "âœ“ Updated .gitignore"

      - name: Clean any existing build artifacts
        run: |
          # Clean Maven build artifacts
          mvn clean || echo "Maven clean skipped"
          
          # Remove any .class files that might be tracked
          find . -name "*.class" -type f -delete || true
          
          # Remove target directory if it exists
          rm -rf target/ || true
          
          echo "âœ“ Cleaned build artifacts"

      - name: Display Migration Plan
        run: |
          echo "=========================================="
          echo "Migration Plan"
          echo "=========================================="
          echo "Project: Spring Framework PetClinic"
          echo "Current Java Version: ${{ needs.detect-current-version.outputs.current_version }}"
          echo "Target Java Version: ${{ github.event.inputs.target_java_version }}"
          echo "Spring Framework Version: 7.0.3"
          echo "=========================================="

      - name: Run Java Migration Recipes
        run: |
          CURRENT_VERSION=${{ needs.detect-current-version.outputs.current_version }}
          TARGET_VERSION=${{ github.event.inputs.target_java_version }}
          
          echo "ðŸš€ Starting migration from Java $CURRENT_VERSION to Java $TARGET_VERSION"
          
          # Java 17 to 21 migration
          if [ "$TARGET_VERSION" -ge "21" ] && [ "$CURRENT_VERSION" -lt "21" ]; then
            echo "Step 1: Migrating to Java 21"
            mvn -U org.openrewrite.maven:rewrite-maven-plugin:6.29.0:run \
              -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:3.27.0 \
              -Drewrite.activeRecipes=org.openrewrite.java.migrate.UpgradeToJava21 \
              -Drewrite.exportDatatables=true || echo "Java 21 migration completed with warnings"
          fi
          
          # Java 25 (experimental)
          if [ "$TARGET_VERSION" -eq "25" ]; then
            echo "Step 2: Setting Java version to 25 (experimental)"
            if [ -f "pom.xml" ]; then
              # Update Java version
              sed -i 's/<java.version>17<\/java.version>/<java.version>25<\/java.version>/g' pom.xml
              sed -i 's/<maven.compiler.source>17<\/maven.compiler.source>/<maven.compiler.source>25<\/maven.compiler.source>/g' pom.xml
              sed -i 's/<maven.compiler.target>17<\/maven.compiler.target>/<maven.compiler.target>25<\/maven.compiler.target>/g' pom.xml
              
              # Update Jetty image to use Java 25 when available
              sed -i 's/jetty:11.0-jdk17/jetty:12.0-jdk21/g' pom.xml || true
              
              echo "âœ“ Updated Java version to 25 in pom.xml"
            fi
          fi

      - name: Update Spring Framework Dependencies
        run: |
          echo "ðŸ”„ Updating Spring Framework and Jakarta EE dependencies"
          
          # Update to latest compatible versions for Java 21/25
          mvn -U org.openrewrite.maven:rewrite-maven-plugin:6.29.0:run \
            -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-migrate-java:3.27.0 \
            -Drewrite.activeRecipes=org.openrewrite.java.dependencies.UpgradeDependencyVersion || echo "Dependency updates completed"

      - name: Apply Best Practices and Code Improvements
        run: |
          echo "ðŸ”§ Applying code modernization"
          
          # Apply common static analysis improvements
          mvn -U org.openrewrite.maven:rewrite-maven-plugin:6.29.0:run \
            -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-static-analysis:2.6.0 \
            -Drewrite.activeRecipes=org.openrewrite.staticanalysis.CommonStaticAnalysis || echo "Static analysis completed"

      - name: Check for changes
        id: check_changes
        run: |
          # Reset workflow file to avoid committing it
          git checkout HEAD -- .github/workflows/java-migration.yml 2>/dev/null || true
          
          # Clean up any build artifacts that might have been generated
          git clean -fdx target/ 2>/dev/null || true
          find . -name "*.class" -type f -delete 2>/dev/null || true
          
          # Check for actual source code changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ Changes detected:"
            git status --short
            
            # Verify no .class files are staged
            if git status --short | grep -q '\.class$'; then
              echo "âš ï¸ WARNING: .class files detected, removing..."
              git reset HEAD -- '*.class' 2>/dev/null || true
              find . -name "*.class" -type f -delete
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No changes detected after migration"
          fi

      - name: Set up Target JDK for Build
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ github.event.inputs.target_java_version }}
          cache: 'maven'

      - name: Build with Maven
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ðŸ”¨ Building project with Java ${{ github.event.inputs.target_java_version }}"
          mvn clean compile -DskipTests || {
            echo "âš ï¸ Build failed - storing status for report"
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            exit 0
          }
          echo "âœ“ Build successful"
          echo "BUILD_STATUS=success" >> $GITHUB_ENV

      - name: Run Tests
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ðŸ§ª Running tests"
          mvn test || {
            echo "âš ï¸ Some tests failed - needs manual review"
            echo "TEST_STATUS=failed" >> $GITHUB_ENV
            exit 0
          }
          echo "âœ“ All tests passed"
          echo "TEST_STATUS=success" >> $GITHUB_ENV

      - name: Clean build artifacts before commit
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ðŸ§¹ Cleaning build artifacts"
          mvn clean || true
          git clean -fdx target/ || true
          find . -name "*.class" -type f -delete || true
          
          # Ensure .gitignore is updated
          if [ -n "$(git status --porcelain .gitignore)" ]; then
            git add .gitignore
          fi

      - name: Generate Migration Report
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          cat > MIGRATION_REPORT.md << 'EOFMARKER'
          # Java Migration Report - Spring Framework PetClinic
          
          ## Project Information
          - **Project:** Spring Framework Petclinic
          - **Type:** Spring Framework 7.0.3 (not Spring Boot)
          - **Build:** Maven WAR packaging
          
          ## Migration Details
          - **From:** Java ${{ needs.detect-current-version.outputs.current_version }}
          - **To:** Java ${{ github.event.inputs.target_java_version }}
          - **Date:** $(date)
          - **Branch:** ${{ env.MIGRATION_BRANCH }}
          
          ## Build Status
          - **Compilation:** ${BUILD_STATUS:-pending}
          - **Tests:** ${TEST_STATUS:-pending}
          
          ## Key Dependencies (Post-Migration)
          - Spring Framework: 7.0.3
          - Jakarta EE (Servlet, JPA, etc.)
          - Hibernate 7.2.3.Final
          - Java: ${{ github.event.inputs.target_java_version }}
          
          ## Changes Applied
          EOFMARKER
          
          CURRENT=${{ needs.detect-current-version.outputs.current_version }}
          TARGET=${{ github.event.inputs.target_java_version }}
          
          if [ "$TARGET" -ge "21" ] && [ "$CURRENT" -lt "21" ]; then
            echo "- âœ… Migrated Java 17 â†’ Java 21" >> MIGRATION_REPORT.md
            echo "- âœ… Updated code for Java 21 features" >> MIGRATION_REPORT.md
          fi
          
          if [ "$TARGET" -eq "25" ]; then
            echo "- âœ… Updated to Java 25 (experimental)" >> MIGRATION_REPORT.md
            echo "- âš ï¸ Note: Java 25 support is experimental" >> MIGRATION_REPORT.md
          fi
          
          cat >> MIGRATION_REPORT.md << 'EOFMARKER'
          
          ## Next Steps
          1. Review all code changes carefully
          2. Run full test suite locally: `mvn clean test`
          3. Test the application: `mvn jetty:run`
          4. Check for deprecation warnings
          5. Update documentation if needed
          6. Test database migrations (H2, HSQLDB, MySQL, PostgreSQL)
          
          ## OpenRewrite Recipes Applied
          EOFMARKER
          
          if [ "$TARGET" -ge "21" ]; then
            echo "- org.openrewrite.java.migrate.UpgradeToJava21" >> MIGRATION_REPORT.md
            echo "- org.openrewrite.staticanalysis.CommonStaticAnalysis" >> MIGRATION_REPORT.md
          fi
          
          cat >> MIGRATION_REPORT.md << 'EOFMARKER'
          
          ## Important Notes for Spring Framework 7.0
          
          This project uses **Spring Framework 7.0** (not Spring Boot), which requires:
          - Java 17 minimum
          - Jakarta EE 9+ (javax.* â†’ jakarta.*)
          - Servlet 6.0+
          - Tomcat 11 or Jetty 11+
          
          The migration preserves the Spring Framework architecture and dependencies.
          
          ## Testing Checklist
          - [ ] Run with H2 database: `mvn clean test -PH2`
          - [ ] Run with HSQLDB: `mvn clean test -PHSQLDB`
          - [ ] Build WAR file: `mvn clean package`
          - [ ] Deploy to Jetty: `mvn jetty:run`
          - [ ] Test all REST endpoints
          - [ ] Verify database operations
          EOFMARKER
          
          cat MIGRATION_REPORT.md

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.MIGRATION_BRANCH }}
          commit-message: |
            ðŸš€ Migrate to Java ${{ github.event.inputs.target_java_version }}
            
            - Upgraded from Java ${{ needs.detect-current-version.outputs.current_version }} to Java ${{ github.event.inputs.target_java_version }}
            - Applied OpenRewrite migration recipes
            - Updated code for Java ${{ github.event.inputs.target_java_version }} compatibility
            
            Build Status: ${BUILD_STATUS:-pending}
            Test Status: ${TEST_STATUS:-pending}
          title: "ðŸš€ Migrate Spring Framework PetClinic to Java ${{ github.event.inputs.target_java_version }}"
          body: |
            ## ðŸŽ¯ Automated Java Migration
            
            This PR migrates the **Spring Framework Petclinic** from Java **${{ needs.detect-current-version.outputs.current_version }}** to Java **${{ github.event.inputs.target_java_version }}**.
            
            ### ðŸ“‹ Migration Summary
            
            | Item | Status |
            |------|--------|
            | Project Type | Spring Framework 7.0 (WAR) |
            | Source Java Version | ${{ needs.detect-current-version.outputs.current_version }} |
            | Target Java Version | ${{ github.event.inputs.target_java_version }} |
            | Build Status | ${BUILD_STATUS:-pending} |
            | Test Status | ${TEST_STATUS:-pending} |
            
            ### ðŸ”§ Changes Applied
            
            - âœ… Upgraded Java version in `pom.xml`
            - âœ… Applied Java ${{ github.event.inputs.target_java_version }} migration recipes
            - âœ… Code modernization and best practices
            - âœ… Updated `.gitignore` to exclude build artifacts
            - âŒ **No build artifacts** (`.class` files, `target/`) included
            
            ### âš ï¸ Important Notes
            
            This project uses **Spring Framework 7.0**, not Spring Boot:
            - WAR packaging for servlet containers
            - Requires Tomcat 11 or Jetty 11+
            - Jakarta EE 9+ dependencies
            
            ### âœ… Testing Checklist
            
            - [ ] Review code changes in detail
            - [ ] Check `MIGRATION_REPORT.md` for details
            - [ ] Run with H2: `mvn clean test -PH2`
            - [ ] Run with HSQLDB: `mvn clean test -PHSQLDB`
            - [ ] Build WAR: `mvn clean package`
            - [ ] Deploy and test: `mvn jetty:run`
            - [ ] Test all database profiles
            - [ ] Verify REST API endpoints
            - [ ] Check for deprecation warnings
            
            ### ðŸ“š Documentation
            
            See `MIGRATION_REPORT.md` in this PR for detailed migration information.
            
            ### ðŸ¤– Automated by
            
            This migration was performed automatically using OpenRewrite and GitHub Actions.
            
            ---
            
            **Note:** Only source code changes are included. Build artifacts are properly excluded.
          labels: |
            migration
            automated
            java-${{ github.event.inputs.target_java_version }}
            enhancement
          draft: false

  migration-blocked:
    name: Migration Not Possible
    runs-on: ubuntu-latest
    needs: detect-current-version
    if: needs.detect-current-version.outputs.can_migrate == 'false'
    
    steps:
      - name: Display Warning
        run: |
          echo "=========================================="
          echo "âš ï¸  Migration Blocked"
          echo "=========================================="
          echo "Current Java version: ${{ needs.detect-current-version.outputs.current_version }}"
          echo "Target Java version: ${{ github.event.inputs.target_java_version }}"
          echo ""
          echo "Cannot migrate backwards or to the same version."
          echo "=========================================="
          exit 1
